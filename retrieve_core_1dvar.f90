

!!   The subroutine returns the retrieved emissivity  
!! Jiheng Hu, 2024/1/21


subroutine retrieve_core_1dvar(imonth,longitude,latitude,&
		TBobs,Tatm,QWatm,LST,T2m,Snowc,Smc,Psrf,EmissAnalyt,Emiss1st,Em1DVar,LstTune)


integer,					parameter 	:: nlevel=29
integer, 					parameter 	:: nchannel=9     !! GMI
real, 						parameter 	:: incident=52.8  !! GMI
integer,dimension(nchannel),parameter 	:: channels=(/1,2,3,4,5,6,7,8,9/)  !! GMI
real, 	dimension(nlevel),	parameter 	:: PLEVEL=(/50.0,70.0,100.0,125.0,150.0,175.0,200.0,225.0   &
												,250.0,300.0,350.0,400.0,450.0,500.0,550.0,600.0&
												,650.0,700.0,750.0,775.0,800.0,825.0,850.0,875.0&
												,900.0,925.0,950.0,975.0,1000.0/)  !! hpa
		
real,	dimension(nlevel),  parameter 	:: PHALF= (/40.,60.,85.,112.5,137.5,162.5,187.5,212.5,237.5 &
												,275.,325.,375.,425.,475.,525.,575.,625.,675.,725.&
												,762.5,787.5,812.5,837.5,862.5,887.5,912.5,937.5,962.5,987.5/)  !! hpa
real,   dimension(nlevel)				:: pmb

integer,					intent(IN)	:: imonth
real,  						intent(IN)	:: longitude,latitude
real, 	dimension(nchannel),intent(IN) 	:: TBobs
real, 	dimension(nlevel), 	intent(IN)	:: Tatm,QWatm
real, 						intent(IN)	:: LST,T2m,Snowc,Smc,Psrf

real, 	dimension(nchannel),intent(OUT)	:: EmissAnalyt,Em1DVar,Emiss1st,LstTune

!! 8 EOFs
real, dimension(8,8)				 	:: LambdaQW  ! pcvar :(30.58026, 17.67337, 11.69979, 8.050688, 5.817812, 4.843317, 3.952374, 2.973315 ) %
real, dimension(8,8)		 			:: LambdaTA  ! pcvar :(29.69952, 11.34457, 9.393681, 6.925895, 4.883001, 3.886191, 3.609612, 3.441968 ) %
real, dimension(9,9)  					:: LambdaEM !!! 0.25*0.25
real, dimension(9,9)  					:: LambdaTB  !! NEDT*NEDT

real, dimension(9,9)					:: Uem, UTB
real, dimension(29,8) 					:: Uqw, Uta			
real, dimension(68,26)      			:: U
REAL, dimension(26,26)					:: Lambda

LambdaQW(1,:)=(/3.710733e-06,0.,0.,0.,0.,0.,0.,0./)
LambdaQW(2,:)=(/0.,2.144559e-06,0.,0.,0.,0.,0.,0./)
LambdaQW(3,:)=(/0.,0.,1.4197e-06,0.,0.,0.,0.,0./)
LambdaQW(4,:)=(/0.,0.,0.,9.769033e-07,0.,0.,0.,0./)
LambdaQW(5,:)=(/0.,0.,0.,0.,7.059569e-07,0.,0.,0./)
LambdaQW(6,:)=(/0.,0.,0.,0.,0.,5.877077e-07,0.,0./)
LambdaQW(7,:)=(/0.,0.,0.,0.,0.,0.,4.795971e-07,0./)
LambdaQW(8,:)=(/0.,0.,0.,0.,0.,0.,0.,3.607942e-07/)

LambdaTA(1,:)=(/9.89189,0.,0.,0.,0.,0.,0.,0./)
LambdaTA(2,:)=(/0.,3.778485,0.,0.,0.,0.,0.,0./)
LambdaTA(3,:)=(/0.,0.,3.128712,0.,0.,0.,0.,0./)
LambdaTA(4,:)=(/0.,0.,0.,2.306777,0.,0.,0.,0./)
LambdaTA(5,:)=(/0.,0.,0.,0.,1.626359,0.,0.,0./)
LambdaTA(6,:)=(/0.,0.,0.,0.,0.,1.294356,0.,0./)
LambdaTA(7,:)=(/0.,0.,0.,0.,0.,0.,1.202237,0./)
LambdaTA(8,:)=(/0.,0.,0.,0.,0.,0.,0.,1.146401/)

!! 0.25*0.25
LambdaEM(1,:)=(/0.0625,0.,0.,0.,0.,0.,0.,0.,0./)
LambdaEM(2,:)=(/0.,0.0625,0.,0.,0.,0.,0.,0.,0./)
LambdaEM(3,:)=(/0.,0.,0.0625,0.,0.,0.,0.,0.,0./)
LambdaEM(4,:)=(/0.,0.,0.,0.0625,0.,0.,0.,0.,0./)
LambdaEM(5,:)=(/0.,0.,0.,0.,0.0625,0.,0.,0.,0./)
LambdaEM(6,:)=(/0.,0.,0.,0.,0.,0.0625,0.,0.,0./)
LambdaEM(7,:)=(/0.,0.,0.,0.,0.,0.,0.0625,0.,0./)
LambdaEM(8,:)=(/0.,0.,0.,0.,0.,0.,0.,0.0625,0./)
LambdaEM(9,:)=(/0.,0.,0.,0.,0.,0.,0.,0.,0.0625/)

!! NEDT*NEDT
LambdaTB(1,:)=(/0.77,0.,0.,0.,0.,0.,0.,0.,0./)
LambdaTB(2,:)=(/0.,0.78,0.,0.,0.,0.,0.,0.,0./)
LambdaTB(3,:)=(/0.,0.,0.63,0.,0.,0.,0.,0.,0./)
LambdaTB(4,:)=(/0.,0.,0.,0.60,0.,0.,0.,0.,0./)
LambdaTB(5,:)=(/0.,0.,0.,0.,0.51,0.,0.,0.,0./)
LambdaTB(6,:)=(/0.,0.,0.,0.,0.,0.41,0.,0.,0./)
LambdaTB(7,:)=(/0.,0.,0.,0.,0.,0.,0.42,0.,0./)
LambdaTB(8,:)=(/0.,0.,0.,0.,0.,0.,0.,0.32,0./)
LambdaTB(9,:)=(/0.,0.,0.,0.,0.,0.,0.,0.,0.31/)


!!! transform matrix
Uem(1,:)=(/1.,0.,0.,0.,0.,0.,0.,0.,0./)
Uem(2,:)=(/0.,1.,0.,0.,0.,0.,0.,0.,0./)
Uem(3,:)=(/0.,0.,1.,0.,0.,0.,0.,0.,0./)
Uem(4,:)=(/0.,0.,0.,1.,0.,0.,0.,0.,0./)
Uem(5,:)=(/0.,0.,0.,0.,1.,0.,0.,0.,0./)
Uem(6,:)=(/0.,0.,0.,0.,0.,1.,0.,0.,0./)
Uem(7,:)=(/0.,0.,0.,0.,0.,0.,1.,0.,0./)
Uem(8,:)=(/0.,0.,0.,0.,0.,0.,0.,1.,0./)
Uem(9,:)=(/0.,0.,0.,0.,0.,0.,0.,0.,1./)

UTB(1,:)=(/1.,0.,0.,0.,0.,0.,0.,0.,0./)
UTB(2,:)=(/0.,1.,0.,0.,0.,0.,0.,0.,0./)
UTB(3,:)=(/0.,0.,1.,0.,0.,0.,0.,0.,0./)
UTB(4,:)=(/0.,0.,0.,1.,0.,0.,0.,0.,0./)
UTB(5,:)=(/0.,0.,0.,0.,1.,0.,0.,0.,0./)
UTB(6,:)=(/0.,0.,0.,0.,0.,1.,0.,0.,0./)
UTB(7,:)=(/0.,0.,0.,0.,0.,0.,1.,0.,0./)
UTB(8,:)=(/0.,0.,0.,0.,0.,0.,0.,1.,0./)
UTB(9,:)=(/0.,0.,0.,0.,0.,0.,0.,0.,1./)

!!! transform matrix
Uqw(1,:) =(/-0.000382063, -0.0011944,   -0.000421503, 0.00222746, -8.01516e-05,  0.00198589, 2.10826e-05, 0.00136297/)
Uqw(2,:) =(/-0.000322739, -0.000942002, -0.000407001, 0.00167294, -4.52086e-05,  0.00139327, 0.00015866,  0.000942571/)
Uqw(3,:) =(/-0.0002227,   -0.00076239,  -0.000307406, 0.00153383, -2.2678e-05 ,  0.00139612, 0.000112131, 0.000903424/)
Uqw(4,:) =(/-0.000214324, -0.000656969, -0.000318945, 0.00168168, -0.000170118,  0.00186946,-6.78564e-05, 0.00122322/)
Uqw(5,:) =(/-0.000205119, -0.000550905, -0.000330877, 0.00186381, -0.000326106,  0.00240173,-0.000259811, 0.00151051/)
Uqw(6,:) =(/-0.000371955, -0.000328094, -0.000444385, 0.00181253, -0.000709763,  0.00310451,-0.000641186, 0.00183901/)
Uqw(7,:) =(/-0.000527743, -0.000136891, -0.000664184, 0.00167169, -0.00125587 ,  0.00385525,-0.00128532,  0.00200018/)
Uqw(8,:) =(/-0.00134473,   0.000476538, -0.000779512, 0.00146731, -0.00189408 ,  0.00507916,-0.00210066,  0.00237257/)
Uqw(9,:) =(/-0.00225696,   0.00100894,  -0.00116727,  0.00145853, -0.00262842 ,  0.00672413,-0.00297796,  0.00292997/)
Uqw(10,:)=(/-0.00545306,   0.00315655,  -0.00149117,  0.00185868, -0.00479306 ,  0.0130594 ,-0.00629711,  0.00596942/)
Uqw(11,:)=(/-0.0101585,	   0.00579279,  -0.00202561,  0.00261523, -0.00820546 ,  0.0225691 ,-0.010501,	  0.0111852/)
Uqw(12,:)=(/-0.0160152,    0.00853757,  -0.00481002,  0.00542158, -0.013793,	0.035651 ,	-0.0181493,	  0.0189666/)
Uqw(13,:)=(/-0.0236797,    0.0134041,   -0.00673347,  0.00958556, -0.02331,		0.0587257,	-0.032474,	  0.0312095/)
Uqw(14,:)=(/-0.0331282,    0.0187954,   -0.0101658,   0.016847,   -0.0311726,	0.0920663,	-0.0533986,	  0.0547974/)
Uqw(15,:)=(/-0.0456509,    0.0272957,	-0.0234686,	  0.0306448,  -0.0579131,	0.180978 ,	-0.108095,	  0.123951/)
Uqw(16,:)=(/-0.0618832,    0.038248, 	-0.0327996,	  0.0478157,  -0.0992585,	0.318007 ,	-0.20002,	  0.201904/)
Uqw(17,:)=(/-0.075952, 	   0.0565012,	-0.0516306,	  0.0684709,  -0.159041 ,	0.481706 ,	-0.310538,	  0.187812/)
Uqw(18,:)=(/-0.0956353,    0.0832958,   -0.0944699,	  0.112994,	  -0.241007 ,	0.496577 ,	-0.210223,	 -0.191104/)
Uqw(19,:)=(/-0.152589, 	   0.181329, 	-0.260879,	  0.305284,	  -0.385829 ,	0.0360549,	 0.383291,	 -0.363767/)
Uqw(20,:)=(/-0.18948, 	   0.239241, 	-0.350178,	  0.325755,	  -0.218995 ,   -0.228133 ,	 0.202695,	  0.113356/)
Uqw(21,:)=(/-0.216979, 	   0.270849, 	-0.357725,	  0.156655,	   0.183744 ,   -0.290591 ,	-0.276031,	  0.370309/)
Uqw(22,:)=(/-0.235571, 	   0.275168, 	-0.264766,	 -0.132258,	   0.441886 ,   -0.0323578,	-0.30012,	 -0.161138/)
Uqw(23,:)=(/-0.25334,	   0.26306, 	-0.0930911,	 -0.383584,	   0.290542 ,	0.228428 ,	 0.19977,	 -0.391783/)
Uqw(24,:)=(/-0.276708,	   0.236423, 	 0.118606,	 -0.439726,	  -0.118184 ,	0.117428 ,	 0.360138,	  0.252674/)
Uqw(25,:)=(/-0.300529,	   0.186882,     0.297408,	 -0.266558,	  -0.352347 ,   -0.172368 ,	-0.0233421,	  0.303934/)
Uqw(26,:)=(/-0.321221,	   0.0962831, 	 0.407768,	  0.0652105,  -0.226322 ,   -0.284606 ,	-0.391776,	 -0.306358/)
Uqw(27,:)=(/-0.351273, 	  -0.0417583, 	 0.376112,	  0.361975,	   0.204157 ,	0.00470931,	-0.0269605,	 -0.222274/)
Uqw(28,:)=(/-0.368859, 	  -0.197489, 	 0.204496,	  0.36191,	   0.372475 ,	0.224741,	 0.344113,	  0.320126/)
Uqw(29,:)=(/-0.470805,	  -0.733332,    -0.370288,	 -0.244381,	  -0.146931 ,   -0.0863411,	-0.078964,	 -0.0618466/)

Uta(1,:)=(/0.0149302, -0.286014, -0.323548, -0.192165, 0.139185, 0.326712, 0.710704, -0.243499/)
Uta(2,:)=(/0.0183128, -0.315065, -0.357322, -0.200524, 0.137529, 0.337416, -0.69991, -0.177038/)
Uta(3,:)=(/0.0207268, -0.293733, -0.297779, -0.136351, 0.0659396, -0.0838554, 0.0469805, 0.146221/)
Uta(4,:)=(/0.0217665, -0.264621, -0.237288, -0.0937236, 0.025914, -0.135942, 0.0130143, 0.190574/)
Uta(5,:)=(/0.017838, -0.215408, -0.172634, -0.0524914, -0.00861389, -0.21971, -0.00374445, 0.180668/)
Uta(6,:)=(/0.015348, -0.189795, -0.144772, -0.0212017, -0.0708476, -0.347084, -0.000247551, 0.191696/)
Uta(7,:)=(/0.0154779, -0.17497, -0.089331, 0.0580572, -0.176967, -0.38068, 0.00618015, 0.0486453/)
Uta(8,:)=(/0.00889305, -0.182239, -0.0574056, 0.144969, -0.255783, -0.299056, 0.00797026, -0.0892459/)
Uta(9,:)=(/0.00749889, -0.188205, -0.0157274, 0.197051, -0.248375, -0.157814, 0.00330338, -0.126616/)
Uta(10,:)=(/0.00618245, -0.196505, 0.0373657, 0.248955, -0.206154, 0.0337273, -0.00328084, -0.130316/)
Uta(11,:)=(/0.00560058, -0.200446, 0.063263, 0.271728, -0.166131, 0.12366, -0.00181609, -0.110512/)
Uta(12,:)=(/0.00339125, -0.186522, 0.0753541, 0.251079, -0.122112, 0.149602, -0.00321952, -0.081861/)
Uta(13,:)=(/0.00354892, -0.177362, 0.0872268, 0.234433, -0.0816924, 0.160387, -0.00362311, -0.0432113/)
Uta(14,:)=(/0.00386561, -0.166196, 0.092876, 0.207873, -0.0422353, 0.15421, 3.51761e-06, -0.0122307/)
Uta(15,:)=(/0.00308097, -0.162499, 0.105077, 0.189266, -0.0024944, 0.15584, -0.000386532, 0.0306434/)
Uta(16,:)=(/0.00401407, -0.158886, 0.117453, 0.161364, 0.0332378, 0.14119, 7.99292e-05, 0.0694412/)
Uta(17,:)=(/0.00117156, -0.142644, 0.113651, 0.129677, 0.0658885, 0.110437, 0.00148544, 0.0940696/)
Uta(18,:)=(/-2.2904e-05, -0.130245, 0.113593, 0.100287, 0.120182, 0.0720442, 0.00283088, 0.131698/)
Uta(19,:)=(/-0.000320684, -0.136192, 0.136455, 0.0879394, 0.23614, 0.0192582, 0.00729063, 0.236916/)
Uta(20,:)=(/-0.000259333, -0.139423, 0.150748, 0.0807607, 0.300276, -0.0199461, 0.00965807, 0.258696/)
Uta(21,:)=(/-0.0019749, -0.137307, 0.159994, 0.0605051, 0.33102, -0.0637629, 0.0117138, 0.189442/)
Uta(22,:)=(/-0.00203511, -0.132027, 0.165192, 0.0267856, 0.318808, -0.112327, 0.00721207, 0.0447181/)
Uta(23,:)=(/0.000566985, -0.128679, 0.177913, -0.0271136, 0.275113, -0.159592, -0.00422665, -0.152187/)
Uta(24,:)=(/0.00616187, -0.139346, 0.209848, -0.102015, 0.206365, -0.196505, -0.0186885, -0.338977/)
Uta(25,:)=(/0.0155251, -0.153038, 0.246914, -0.201345, 0.0749661, -0.178897, -0.0264622, -0.399498/)
Uta(26,:)=(/0.0313577, -0.166446, 0.286022, -0.304631, -0.105698, -0.0737946, -0.018611, -0.235508/)
Uta(27,:)=(/0.0619927, -0.171606, 0.30319, -0.377319, -0.269467, 0.090234, 0.00418383, 0.106371/)
Uta(28,:)=(/0.133013, -0.149071, 0.275742, -0.360636, -0.332127, 0.220095, 0.0265447, 0.397965/)
Uta(29,:)=(/0.987253, 0.0793131, -0.0418795, 0.0881041, 0.0683952, -0.0202147, -0.0017761, -0.0478213/)

U=0.0
U(1:29,1:8)=Uta
U(30:58,9:16)=Uqw
U(59:59,17:17)=1.0   !! LST
U(60:68,18:26)=Uem   !! emissivity

Lambda=0.0
Lambda(1:8,1:8)=LambdaTA
Lambda(9:16,9:16)=LambdaQW
Lambda(17,17)=12.773  !! k*k   Stdev^2 
Lambda(18:26,18:26)=LambdaEM

! do ix=1,26
! 	print*,Lambda(:,ix)

! end do
! do ix=1,26
! 	print*,U(:,ix)

! end do
! stop


!! calculate effective Layer



!!! perform a inital clear sky forward modeling to get the emissivity 1st guess, the analytic emissivity solution.
call rttov_fwd_clearsky(imonth,nlevel,nchannel,incident,channels,longitude,latitude,plevel,phalf,&
				QWatm,Tatm,LST,Psrf,T2m,Snowc,Smc,TBobs,EmissAnalyt,Emiss1st)

!!! Determine the number of principle components
! NEOF=8  !! for vapor and Ta
!! read in Ta error matrix


! print*,QWatm
! print*,MATMUL(QWatm, Uqw)
! print*,MATMUL(Uqw,MATMUL(QWatm, Uqw))


! print*,Tatm
! print*,MATMUL(Tatm, Uta)
! print*,MATMUL(Uta,MATMUL(Tatm, Uta))






end subroutine retrieve_core_1dvar
