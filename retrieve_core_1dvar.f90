

!!   The subroutine returns the retrieved emissivity  
!! Jiheng Hu, 2024/1/21


subroutine retrieve_core_1dvar(nlevel,nchannel,imonth,incident,longitude,latitude,&
		PLEVEL,PHALF,TBobs,Tatm,QWatm,LST,T2m,Snowc,Smc,SfcPress,&
		EmissAnalyt,Emiss1st,Em1DVar,TbTune,LstTune,nIters)


integer,					intent(IN)	:: nlevel
integer,					intent(IN)	:: nchannel
integer,					intent(IN)	:: imonth
real,						intent(IN)	:: incident
real,  						intent(IN)	:: longitude
real,  						intent(IN)	:: latitude

real, 	dimension(nlevel),  intent(IN)	:: PLEVEL
real, 	dimension(nlevel),  intent(IN)	:: PHALF
real, 	dimension(nchannel),intent(IN) 	:: TBobs
real, 	dimension(nlevel), 	intent(IN)	:: Tatm,QWatm
real, 						intent(IN)	:: LST,T2m,Snowc,Smc,SfcPress

real, 	dimension(nchannel),intent(OUT)	:: EmissAnalyt,Em1DVar,Emiss1st,TbTune
real,						intent(OUT)	:: LstTune
INTEGER,					intent(OUT) :: nIters


real, 	dimension(nchannel)				:: Emss_K,LST_K
real, 	dimension(nchannel,nlevel)		:: Ta_K,Qw_K
real, 	dimension(nchannel,68)			:: Ja

!!! covariance
integer,	parameter					:: nEOF=8
real, 		dimension(nlevel,nlevel) 	:: CovQw, CovTa, CovQw1, CovTa1
real, 		dimension(nlevel,nEOF)		:: UQw, UTa

!! cov in EOF space
real, 		dimension(nEOF,nEOF)		:: LambdaQw,LambdaTa

real, 		dimension(nchannel)         :: EY

!! TB and EMissivity
real, dimension(nchannel,nchannel)      :: LambdaEM  !! 0.25*0.25
real, dimension(nchannel,nchannel)  	:: LambdaTB  !! NEDT*NEDT
real, dimension(nchannel,nchannel)		:: Uem, UTB

!! Total tranform EigenVectorMatrix and EigenValueMatrix
real, dimension(68,26)      			:: Utotal
real, dimension(68)      				:: Xb, Xg, DX
REAL, dimension(26,26)					:: Lambda
integer :: file_unit

INTEGER ::  nLayEff
INTEGER ::  iter,ich
LOGICAL ::  CvgceReached
REAL, parameter ::  ChiSqThresh=1.0


!! departures 
REAL, DIMENSION(nchannel) :: dY2

EY=(/0.77,0.78,0.63,0.60,0.51,0.41,0.42,0.32,0.31/)  

! 0.25*0.25
LambdaEM(1,:)=(/0.0625,0.,0.,0.,0.,0.,0.,0.,0./)
LambdaEM(2,:)=(/0.,0.0625,0.,0.,0.,0.,0.,0.,0./)
LambdaEM(3,:)=(/0.,0.,0.0625,0.,0.,0.,0.,0.,0./)
LambdaEM(4,:)=(/0.,0.,0.,0.0625,0.,0.,0.,0.,0./)
LambdaEM(5,:)=(/0.,0.,0.,0.,0.0625,0.,0.,0.,0./)
LambdaEM(6,:)=(/0.,0.,0.,0.,0.,0.0625,0.,0.,0./)
LambdaEM(7,:)=(/0.,0.,0.,0.,0.,0.,0.0625,0.,0./)
LambdaEM(8,:)=(/0.,0.,0.,0.,0.,0.,0.,0.0625,0./)
LambdaEM(9,:)=(/0.,0.,0.,0.,0.,0.,0.,0.,0.0625/)

! NEDT*NEDT
LambdaTB(1,:)=(/0.77,0.,0.,0.,0.,0.,0.,0.,0./)
LambdaTB(2,:)=(/0.,0.78,0.,0.,0.,0.,0.,0.,0./)
LambdaTB(3,:)=(/0.,0.,0.63,0.,0.,0.,0.,0.,0./)
LambdaTB(4,:)=(/0.,0.,0.,0.60,0.,0.,0.,0.,0./)
LambdaTB(5,:)=(/0.,0.,0.,0.,0.51,0.,0.,0.,0./)
LambdaTB(6,:)=(/0.,0.,0.,0.,0.,0.41,0.,0.,0./)
LambdaTB(7,:)=(/0.,0.,0.,0.,0.,0.,0.42,0.,0./)
LambdaTB(8,:)=(/0.,0.,0.,0.,0.,0.,0.,0.32,0./)
LambdaTB(9,:)=(/0.,0.,0.,0.,0.,0.,0.,0.,0.31/)

!! transform matrix
Uem(1,:)=(/1.,0.,0.,0.,0.,0.,0.,0.,0./)
Uem(2,:)=(/0.,1.,0.,0.,0.,0.,0.,0.,0./)
Uem(3,:)=(/0.,0.,1.,0.,0.,0.,0.,0.,0./)
Uem(4,:)=(/0.,0.,0.,1.,0.,0.,0.,0.,0./)
Uem(5,:)=(/0.,0.,0.,0.,1.,0.,0.,0.,0./)
Uem(6,:)=(/0.,0.,0.,0.,0.,1.,0.,0.,0./)
Uem(7,:)=(/0.,0.,0.,0.,0.,0.,1.,0.,0./)
Uem(8,:)=(/0.,0.,0.,0.,0.,0.,0.,1.,0./)
Uem(9,:)=(/0.,0.,0.,0.,0.,0.,0.,0.,1./)

UTB(1,:)=(/1.,0.,0.,0.,0.,0.,0.,0.,0./)
UTB(2,:)=(/0.,1.,0.,0.,0.,0.,0.,0.,0./)
UTB(3,:)=(/0.,0.,1.,0.,0.,0.,0.,0.,0./)
UTB(4,:)=(/0.,0.,0.,1.,0.,0.,0.,0.,0./)
UTB(5,:)=(/0.,0.,0.,0.,1.,0.,0.,0.,0./)
UTB(6,:)=(/0.,0.,0.,0.,0.,1.,0.,0.,0./)
UTB(7,:)=(/0.,0.,0.,0.,0.,0.,1.,0.,0./)
UTB(8,:)=(/0.,0.,0.,0.,0.,0.,0.,1.,0./)
UTB(9,:)=(/0.,0.,0.,0.,0.,0.,0.,0.,1./)

 
 !! load precalculate error covariance matrix and EOF EigenVectorMatrix
 ! OPEN(NEWUNIT=file_unit, FILE='matrix/CovMatrx_Qw.bin',form="unformatted")
 ! read(file_unit) CovQw
 ! close(file_unit)
 
 ! OPEN(NEWUNIT=file_unit, FILE='matrix/CovMatrx_Ta.bin',form="unformatted")
 ! read(file_unit) CovTa
 ! close(file_unit)
 
 !! Here we use built-in matrix, to avoid IO blocking in case of massive concurrant processes.

 !! Error covariance matrix of ERA5 specific humidity. [29,8]
 CovQw(1,:)=(/  2.25377153E-06, 6.82676387E-07, 3.90812573E-07, 2.35140632E-07, 1.74413401E-07, 1.45588956E-07,&
				1.29335973E-07, 1.16950091E-07, 1.02898120E-07, 8.75392914E-08, 7.55913590E-08, 6.66142341E-08,&
				5.69793848E-08, 5.35262394E-08, 4.12919761E-08, 2.94169897E-08, 2.16760316E-08, 1.57115512E-08,&
				8.98444785E-09, 4.86240292E-09, 2.61506150E-09, 1.63528346E-09, 1.03944287E-09, 8.72650840E-10,&
				8.45836901E-10, 1.07350995E-09, 1.29057576E-09, 1.76485715E-09, 2.11235940E-09 /)
 CovQw(2,:)=(/  6.82676387E-07, 1.05601953E-06, 6.79278514E-07, 3.78057592E-07, 2.59730314E-07, 2.00952115E-07,&
				1.66440941E-07, 1.47084506E-07, 1.31926171E-07, 1.16452988E-07, 1.00777910E-07, 7.84541641E-08,&
				6.90800164E-08, 6.44658229E-08, 4.79645585E-08, 3.64950026E-08, 2.49634748E-08, 1.77328534E-08,&
				1.12788126E-08, 6.07437523E-09, 2.63350719E-09, 1.84372173E-09, 1.19428045E-09, 1.37267953E-09,&
				1.35566103E-09, 1.35056899E-09, 1.34960698E-09, 1.59774083E-09, 2.03036277E-09 /)
 CovQw(3,:)=(/  3.90812573E-07, 6.79278514E-07, 9.54510256E-07, 5.83712392E-07, 3.54674626E-07, 2.42634059E-07,&
				1.83644431E-07, 1.54796439E-07, 1.36801816E-07, 1.21400163E-07, 1.05197500E-07, 7.74009621E-08,&
				6.96868483E-08, 5.95982570E-08, 4.51197906E-08, 3.58102241E-08, 2.51469476E-08, 1.64821401E-08,&
				1.09472413E-08, 5.63710278E-09, 2.25336283E-09, 1.43891965E-09, 7.23376303E-10, 7.34064531E-10,&
				6.74821754E-10, 6.65080047E-10, 6.75226708E-10, 8.05984279E-10, 1.11099108E-09 /)
 CovQw(4,:)=(/	2.35140632E-07, 3.78057592E-07, 5.83712392E-07, 8.99144197E-07, 5.63228241E-07, 3.29957004E-07,&
				2.17460865E-07, 1.69666123E-07, 1.45500820E-07, 1.27086835E-07, 1.07443313E-07, 7.97267177E-08,&
				6.67784548E-08, 5.63241827E-08, 4.12246912E-08, 3.48658205E-08, 2.57174424E-08, 1.68746457E-08,&
				1.10488632E-08, 5.90089755E-09, 2.00584749E-09, 1.03794617E-09,-6.89999724E-11,-2.32891234E-10,&
			   -4.00228878E-10,-3.66526587E-10,-3.35956707E-10,-3.27438743E-10,-4.57899718E-10 /)
 CovQw(5,:)=(/  1.74413401E-07, 2.59730314E-07, 3.54674626E-07, 5.63228241E-07, 8.33896138E-07, 5.42839530E-07,&
				3.06619597E-07, 2.10473360E-07, 1.69663636E-07, 1.42599816E-07, 1.21124771E-07, 8.56314131E-08,&
				6.92732129E-08, 5.81132653E-08, 4.41760051E-08, 3.55317553E-08, 2.69251643E-08, 1.83835827E-08,&
				1.23318546E-08, 6.31032870E-09, 2.10434914E-09, 1.04732056E-09,-1.28896949E-10,-3.44989814E-10,&
			   -6.23363139E-10,-5.96103555E-10,-5.90894500E-10,-5.87344229E-10,-7.11506687E-10 /)
 CovQw(6,:)=(/  1.45588956E-07, 2.00952115E-07, 2.42634059E-07, 3.29957004E-07, 5.42839530E-07, 7.98862686E-07,&
				4.88570151E-07, 2.87746076E-07, 2.00715832E-07, 1.59695801E-07, 1.33945221E-07, 9.28319679E-08,&
				7.57088543E-08, 6.15816589E-08, 4.68494505E-08, 3.60374983E-08, 2.69037326E-08, 1.86493239E-08,&
				1.26207276E-08, 6.52045751E-09, 2.29478614E-09, 1.08075537E-09,-1.29142114E-10,-4.18330481E-10,&
			   -7.26456284E-10,-7.17575499E-10,-7.21161908E-10,-7.82302945E-10,-1.07491227E-09 /)
 CovQw(7,:)=(/  1.29335973E-07, 1.66440941E-07, 1.83644431E-07, 2.17460865E-07, 3.06619597E-07, 4.88570151E-07,&
				7.87015551E-07, 4.72728487E-07, 2.80362769E-07, 1.99214455E-07, 1.51119337E-07, 9.97498262E-08,&
				7.94650816E-08, 6.20087732E-08, 4.61924472E-08, 3.42312276E-08, 2.52187622E-08, 1.72047478E-08,&
				1.16954331E-08, 6.19538509E-09, 2.15170259E-09, 9.90263094E-10,-1.62922370E-10,-4.31704089E-10,&
			   -7.11655512E-10,-7.00118685E-10,-6.87371604E-10,-7.50580542E-10,-1.05541897E-09 /)
 CovQw(8,:)=(/  1.16950091E-07, 1.47084506E-07, 1.54796439E-07, 1.69666123E-07, 2.10473360E-07, 2.87746076E-07,&
				4.72728487E-07, 7.75799606E-07, 4.86485931E-07, 2.80269148E-07, 1.81768030E-07, 1.05152814E-07,&
				7.91921480E-08, 6.16306934E-08, 4.70395420E-08, 3.41868542E-08, 2.39988740E-08, 1.65308407E-08,&
				1.04328119E-08, 5.74001069E-09, 2.12382223E-09, 1.06133846E-09, 4.02693295E-11,-1.74322112E-10,&
			   -3.95653066E-10,-3.75828729E-10,-3.71475323E-10,-3.69505287E-10,-5.03031505E-10 /)
 CovQw(9,:)=(/  1.02898120E-07, 1.31926171E-07, 1.36801816E-07, 1.45500820E-07, 1.69663636E-07, 2.00715832E-07,&
				2.80362769E-07, 4.86485931E-07, 7.72038106E-07, 4.68442806E-07, 2.60726722E-07, 1.14115004E-07,&
				7.88889736E-08, 6.13802129E-08, 4.86171778E-08, 3.40612125E-08, 2.36942732E-08, 1.65958713E-08,&
				9.92447724E-09, 5.41771872E-09, 2.25107799E-09, 1.23328370E-09, 3.94392324E-10, 1.58048352E-10,&
			   -4.96011600E-11,-6.61938560E-11,-8.43061662E-11,-3.62632251E-11,-1.23114088E-10 /)
 CovQw(10,:)=(/ 8.75392914E-08, 1.16452988E-07, 1.21400163E-07, 1.27086835E-07, 1.42599816E-07, 1.59695801E-07,&
				1.99214455E-07, 2.80269148E-07, 4.68442806E-07, 7.29692431E-07, 4.25697039E-07, 1.29519137E-07,&
				8.42999697E-08, 6.43408598E-08, 4.86219349E-08, 3.32749082E-08, 2.41312055E-08, 1.58851901E-08,&
				9.81388038E-09, 5.54893820E-09, 2.45524778E-09, 1.52719104E-09, 7.61195496E-10, 5.89223281E-10,&
				3.71730230E-10, 3.10384607E-10, 2.51510535E-10, 3.19424293E-10, 3.32471883E-10 /)
 CovQw(11,:)=(/ 7.55913590E-08, 1.00777910E-07, 1.05197500E-07, 1.07443313E-07, 1.21124771E-07, 1.33945221E-07,&
				1.51119337E-07, 1.81768030E-07, 2.60726722E-07, 4.25697039E-07, 6.49191236E-07, 1.68364210E-07,&
				8.85234712E-08, 6.55861356E-08, 4.86570713E-08, 3.22258202E-08, 2.33881359E-08, 1.57617812E-08,&
				9.41885769E-09, 5.39940004E-09, 2.69214184E-09, 1.79321413E-09, 1.07817644E-09, 8.09587175E-10,&
				5.73914416E-10, 4.82678231E-10, 4.02708589E-10, 4.84066676E-10, 5.66972580E-10 /)
 CovQw(12,:)=(/ 6.66142341E-08, 7.84541641E-08, 7.74009621E-08, 7.97267177E-08, 8.56314131E-08, 9.28319679E-08,&
				9.97498262E-08, 1.05152814E-07, 1.14115004E-07, 1.29519137E-07, 1.68364210E-07, 4.70916916E-07,&
				1.44791301E-07, 7.97518780E-08, 5.01589987E-08, 3.30895737E-08, 2.37150868E-08, 1.59128604E-08,&
				9.98833016E-09, 5.80849457E-09, 2.84988966E-09, 1.91348470E-09, 1.18112242E-09, 8.54684046E-10,&
				5.78728343E-10, 4.51129079E-10, 3.50120766E-10, 4.06979922E-10, 5.46426793E-10 /)
 CovQw(13,:)=(/ 5.69793848E-08, 6.90800164E-08, 6.96868483E-08, 6.67784548E-08, 6.92732129E-08, 7.57088543E-08,&
				7.94650816E-08, 7.91921480E-08, 7.88889736E-08, 8.42999697E-08, 8.85234712E-08, 1.44791301E-07,&
				3.91783146E-07, 1.24653951E-07, 6.39054818E-08, 3.63432306E-08, 2.46335485E-08, 1.65929617E-08,&
				1.08675708E-08, 6.28237684E-09, 2.87725466E-09, 2.05109707E-09, 1.36521305E-09, 1.01972164E-09,&
				7.00356773E-10, 5.44176704E-10, 4.08232004E-10, 4.42326537E-10, 6.29133134E-10 /)
 CovQw(14,:)=(/ 5.35262394E-08, 6.44658229E-08, 5.95982570E-08, 5.63241827E-08, 5.81132653E-08, 6.15816589E-08,&
				6.20087732E-08, 6.16306934E-08, 6.13802129E-08, 6.43408598E-08, 6.55861356E-08, 7.97518780E-08,&
				1.24653951E-07, 2.87603257E-07, 8.90095322E-08, 4.09710346E-08, 2.70971725E-08, 1.65485616E-08,&
				1.04615667E-08, 6.16876417E-09, 2.99127900E-09, 2.19694929E-09, 1.51553259E-09, 1.17770815E-09,&
				8.62244554E-10, 6.70565770E-10, 4.77959505E-10, 4.83636076E-10, 6.77876255E-10 /)
 CovQw(15,:)=(/ 4.12919761E-08, 4.79645585E-08, 4.51197906E-08, 4.12246912E-08, 4.41760051E-08, 4.68494505E-08,&
				4.61924472E-08, 4.70395420E-08, 4.86171778E-08, 4.86219349E-08, 4.86570713E-08, 5.01589987E-08,&
				6.39054818E-08, 8.90095322E-08, 1.99757693E-07, 4.87907208E-08, 2.80293033E-08, 1.64563048E-08,&
				9.69165903E-09, 5.66978908E-09, 3.06625547E-09, 2.22311591E-09, 1.63425984E-09, 1.22354993E-09,&
				9.33301547E-10, 6.94228008E-10, 4.63881433E-10, 4.41127190E-10, 6.31943109E-10 /)
 CovQw(16,:)=(/ 2.94169897E-08, 3.64950026E-08, 3.58102241E-08, 3.48658205E-08, 3.55317553E-08, 3.60374983E-08,&
				3.42312276E-08, 3.41868542E-08, 3.40612125E-08, 3.32749082E-08, 3.22258202E-08, 3.30895737E-08,&
				3.63432306E-08, 4.09710346E-08, 4.87907208E-08, 1.19408071E-07, 3.39923716E-08, 1.65684160E-08,&
				9.58451274E-09, 5.22665111E-09, 2.89433943E-09, 2.12198792E-09, 1.49076662E-09, 1.09243348E-09,&
				7.66736952E-10, 5.11345855E-10, 2.81064755E-10, 2.30832478E-10, 3.88873933E-10 /)
 CovQw(17,:)=(/ 2.16760316E-08, 2.49634748E-08, 2.51469476E-08, 2.57174424E-08, 2.69251643E-08, 2.69037326E-08,&
				2.52187622E-08, 2.39988740E-08, 2.36942732E-08, 2.41312055E-08, 2.33881359E-08, 2.37150868E-08,&
				2.46335485E-08, 2.70971725E-08, 2.80293033E-08, 3.39923716E-08, 7.71852697E-08, 1.93027514E-08,&
				9.96031790E-09, 5.44510659E-09, 2.72886491E-09, 2.04969042E-09, 1.37641243E-09, 1.04697429E-09,&
				7.20658200E-10, 4.87110408E-10, 2.66200534E-10, 2.26707181E-10, 4.22527152E-10 /)
 CovQw(18,:)=(/ 1.57115512E-08, 1.77328534E-08, 1.64821401E-08, 1.68746457E-08, 1.83835827E-08, 1.86493239E-08,&
				1.72047478E-08, 1.65308407E-08, 1.65958713E-08, 1.58851901E-08, 1.57617812E-08, 1.59128604E-08,&
				1.65929617E-08, 1.65485616E-08, 1.64563048E-08, 1.65684160E-08, 1.93027514E-08, 3.78924376E-08,&
				1.15411387E-08, 5.17184517E-09, 2.49093612E-09, 1.83775439E-09, 1.22470956E-09, 9.05926778E-10,&
				6.12164208E-10, 3.96063626E-10, 1.90427979E-10, 1.29476083E-10, 2.26056174E-10 /)
 CovQw(19,:)=(/ 8.98444785E-09, 1.12788126E-08, 1.09472413E-08, 1.10488632E-08, 1.23318546E-08, 1.26207276E-08,&
				1.16954331E-08, 1.04328119E-08, 9.92447724E-09, 9.81388038E-09, 9.41885769E-09, 9.98833016E-09,&
				1.08675708E-08, 1.04615667E-08, 9.69165903E-09, 9.58451274E-09, 9.96031790E-09, 1.15411387E-08,&
				1.93077412E-08, 5.16133980E-09, 2.22720620E-09, 1.63285585E-09, 1.09193632E-09, 8.34823377E-10,&
				5.59477631E-10, 3.70696501E-10, 1.87515281E-10, 1.34367475E-10, 2.27499214E-10 /)
 CovQw(20,:)=(/ 4.86240292E-09, 6.07437523E-09, 5.63710278E-09, 5.90089755E-09, 6.31032870E-09, 6.52045751E-09,&
				6.19538509E-09, 5.74001069E-09, 5.41771872E-09, 5.54893820E-09, 5.39940004E-09, 5.80849457E-09,&
				6.28237684E-09, 6.16876417E-09, 5.66978908E-09, 5.22665111E-09, 5.44510659E-09, 5.17184517E-09,&
				5.16133980E-09, 6.89267221E-09, 2.08763207E-09, 1.45796408E-09, 1.00141395E-09, 7.47753748E-10,&
				5.22368315E-10, 3.54375751E-10, 1.99677441E-10, 1.48780821E-10, 2.10267942E-10 /)
 CovQw(21,:)=(/ 2.61506150E-09, 2.63350719E-09, 2.25336283E-09, 2.00584749E-09, 2.10434914E-09, 2.29478614E-09,&
				2.15170259E-09, 2.12382223E-09, 2.25107799E-09, 2.45524778E-09, 2.69214184E-09, 2.84988966E-09,&
				2.87725466E-09, 2.99127900E-09, 3.06625547E-09, 2.89433943E-09, 2.72886491E-09, 2.49093612E-09,&
				2.22720620E-09, 2.08763207E-09, 2.35461761E-09, 1.47759649E-09, 1.00144948E-09, 7.61956831E-10,&
				5.68810776E-10, 4.23741237E-10, 2.97541131E-10, 2.70805822E-10, 3.56745383E-10 /)
 CovQw(22,:)=(/ 1.63528346E-09, 1.84372173E-09, 1.43891965E-09, 1.03794617E-09, 1.04732056E-09, 1.08075537E-09,&
				9.90263094E-10, 1.06133846E-09, 1.23328370E-09, 1.52719104E-09, 1.79321413E-09, 1.91348470E-09,&
				2.05109707E-09, 2.19694929E-09, 2.22311591E-09, 2.12198792E-09, 2.04969042E-09, 1.83775439E-09,&
				1.63285585E-09, 1.45796408E-09, 1.47759649E-09, 1.47007828E-09, 1.01814068E-09, 7.88113907E-10,&
				6.06558748E-10, 4.76011230E-10, 3.64286656E-10, 3.56208146E-10, 4.64707439E-10 /)
 CovQw(23,:)=(/ 1.03944287E-09, 1.19428045E-09, 7.23376303E-10,-6.89999724E-11,-1.28896949E-10,-1.29142114E-10,&
			   -1.62922370E-10, 4.02693295E-11, 3.94392324E-10, 7.61195496E-10, 1.07817644E-09, 1.18112242E-09,&
				1.36521305E-09, 1.51553259E-09, 1.63425984E-09, 1.49076662E-09, 1.37641243E-09, 1.22470956E-09,&
				1.09193632E-09, 1.00141395E-09, 1.00144948E-09, 1.01814068E-09, 1.02979236E-09, 8.34001979E-10,&
				6.69634792E-10, 5.52163149E-10, 4.55393806E-10, 4.64074223E-10, 5.94203131E-10 /)
 CovQw(24,:)=(/ 8.72650840E-10, 1.37267953E-09, 7.34064531E-10,-2.32891234E-10,-3.44989814E-10,-4.18330481E-10,&
			   -4.31704089E-10,-1.74322112E-10, 1.58048352E-10, 5.89223281E-10, 8.09587175E-10, 8.54684046E-10,&
				1.01972164E-09, 1.17770815E-09, 1.22354993E-09, 1.09243348E-09, 1.04697429E-09, 9.05926778E-10,&
				8.34823377E-10, 7.47753748E-10, 7.61956831E-10, 7.88113907E-10, 8.34001979E-10, 8.35805758E-10,&
				7.12189974E-10, 6.21151464E-10, 5.48813273E-10, 5.87827176E-10, 7.51721629E-10 /)
 CovQw(25,:)=(/ 8.45836901E-10, 1.35566103E-09, 6.74821754E-10,-4.00228878E-10,-6.23363139E-10,-7.26456284E-10,&
			   -7.11655512E-10,-3.95653066E-10,-4.96011600E-11, 3.71730230E-10, 5.73914416E-10, 5.78728343E-10,&
				7.00356773E-10, 8.62244554E-10, 9.33301547E-10, 7.66736952E-10, 7.20658200E-10, 6.12164208E-10,&
				5.59477631E-10, 5.22368315E-10, 5.68810776E-10, 6.06558748E-10, 6.69634792E-10, 7.12189974E-10,&
				7.04308334E-10, 6.45508147E-10, 6.01405148E-10, 6.66282196E-10, 8.50378823E-10 /)
 CovQw(26,:)=(/ 1.07350995E-09, 1.35056899E-09, 6.65080047E-10,-3.66526587E-10,-5.96103555E-10,-7.17575499E-10,&
			   -7.00118685E-10,-3.75828729E-10,-6.61938560E-11, 3.10384607E-10, 4.82678231E-10, 4.51129079E-10,&
				5.44176704E-10, 6.70565770E-10, 6.94228008E-10, 5.11345855E-10, 4.87110408E-10, 3.96063626E-10,&
				3.70696501E-10, 3.54375751E-10, 4.23741237E-10, 4.76011230E-10, 5.52163149E-10, 6.21151464E-10,&
				6.45508147E-10, 6.59709509E-10, 6.56921240E-10, 7.60658481E-10, 9.72810055E-10 /)
 CovQw(27,:)=(/ 1.29057576E-09, 1.34960698E-09, 6.75226708E-10,-3.35956707E-10,-5.90894500E-10,-7.21161908E-10,&
			   -6.87371604E-10,-3.71475323E-10,-8.43061662E-11, 2.51510535E-10, 4.02708589E-10, 3.50120766E-10,&
				4.08232004E-10, 4.77959505E-10, 4.63881433E-10, 2.81064755E-10, 2.66200534E-10, 1.90427979E-10,&
				1.87515281E-10, 1.99677441E-10, 2.97541131E-10, 3.64286656E-10, 4.55393806E-10, 5.48813273E-10,&
				6.01405148E-10, 6.56921240E-10, 7.21239901E-10, 8.68755456E-10, 1.11807141E-09 /)
 CovQw(28,:)=(/ 1.76485715E-09, 1.59774083E-09, 8.05984279E-10,-3.27438743E-10,-5.87344229E-10,-7.82302945E-10,&
			   -7.50580542E-10,-3.69505287E-10,-3.62632251E-11, 3.19424293E-10, 4.84066676E-10, 4.06979922E-10,&
				4.42326537E-10, 4.83636076E-10, 4.41127190E-10, 2.30832478E-10, 2.26707181E-10, 1.29476083E-10,&
				1.34367475E-10, 1.48780821E-10, 2.70805822E-10, 3.56208146E-10, 4.64074223E-10, 5.87827176E-10,&
				6.66282196E-10, 7.60658481E-10, 8.68755456E-10, 1.34504863E-09, 1.93016692E-09 /)
 CovQw(29,:)=(/ 2.11235940E-09, 2.03036277E-09, 1.11099108E-09,-4.57899718E-10,-7.11506687E-10,-1.07491227E-09,&
			   -1.05541897E-09,-5.03031505E-10,-1.23114088E-10, 3.32471883E-10, 5.66972580E-10, 5.46426793E-10,&
				6.29133134E-10, 6.77876255E-10, 6.31943109E-10, 3.88873933E-10, 4.22527152E-10, 2.26056174E-10,&
				2.27499214E-10, 2.10267942E-10, 3.56745383E-10, 4.64707439E-10, 5.94203131E-10, 7.51721629E-10,&
				8.50378823E-10, 9.72810055E-10, 1.11807141E-09, 1.93016692E-09, 3.66603214E-09 /)

 !! error covariance matrix of ERA5 Atmos. Temperatures. [29,8] 
CovTa(1 ,:)=(/ 9.69997501    ,  1.06188273    ,  0.409618855   ,  0.174097151   ,  6.85552210E-02,  8.88476241E-03&
			, -2.78132949E-02, -4.53510694E-02, -4.26108539E-02, -2.61215754E-02, -2.76487917E-02, -2.51980964E-02&
			, -1.61948316E-02,  8.63474421E-03,  2.49303319E-03,  1.11986129E-02,  7.41162617E-03,  5.14982175E-03&
			,  2.45501362E-02,  2.83700321E-02,  3.92710082E-02,  5.01138568E-02,  0.107088841   ,  0.100456975   &
			,  0.118547171   ,  0.144162372   ,  0.130702093   ,  0.105246171   ,  7.98874274E-02/)
CovTa(2 ,:)=(/ 1.06188273    ,  1.47379100    ,  0.812250674   ,  0.394982070   ,  0.211665928   ,  0.127838865   &
			,  9.13718566E-02,  7.35643208E-02,  6.96875006E-02,  6.96579888E-02,  7.03774244E-02,  6.58064261E-02&
			,  6.86929151E-02,  7.39764795E-02,  5.54191321E-02,  4.47899513E-02,  4.12805788E-02,  3.40297036E-02&
			,  3.17294337E-02,  2.92330757E-02,  1.83074195E-02,  1.55186374E-02,  3.03882044E-02,  2.66580451E-02&
			,  2.91927252E-02,  3.36599872E-02,  1.78863201E-02,  1.91269591E-02,  2.31658760E-02/)
CovTa(3,:)=(/  0.409618855   ,  0.812250674   ,  1.11617911    ,  0.675803721   ,  0.341781080   ,  0.186129585   &
			,  0.117249288   ,  9.06797498E-02,  8.20079744E-02,  7.95532167E-02,  7.75735676E-02,  7.15421513E-02&
			,  7.28158727E-02,  7.58946165E-02,  5.75700328E-02,  4.88301404E-02,  4.19575870E-02,  3.64593044E-02&
			,  3.16226184E-02,  3.30184996E-02,  2.48787012E-02,  1.82592180E-02,  2.82323342E-02,  2.16992702E-02&
			,  2.65046470E-02,  2.54206229E-02,  1.53768435E-02,  1.14704622E-02,  1.26516288E-02/)
CovTa(4,:)=(/  0.174097151   ,  0.394982070   ,  0.675803721   ,  0.959535122   ,  0.568628430   ,  0.282379299   &
			,  0.153259307   ,  0.108485878   ,  9.26147476E-02,  8.61303136E-02,  8.26010928E-02,  7.74837881E-02&
			,  7.73731545E-02,  7.70609304E-02,  6.09061159E-02,  5.26640490E-02,  4.61906530E-02,  4.12034169E-02&
			,  3.66913788E-02,  3.54958214E-02,  2.55120136E-02,  1.90115552E-02,  2.54305564E-02,  1.58545747E-02&
			,  1.85802374E-02,  2.00621523E-02,  1.07287532E-02,  2.76555819E-03,  1.64459751E-03/)
CovTa(5,:)=(/  6.85552210E-02,  0.211665928   ,  0.341781080   ,  0.568628430   ,  0.812957048   ,  0.494835794   &
			,  0.245371550   ,  0.145605281   ,  0.109592997   ,  9.35356691E-02,  8.83718729E-02,  8.14356878E-02&
			,  7.95709193E-02,  7.70259723E-02,  6.47098124E-02,  5.74070662E-02,  5.26588336E-02,  4.73134257E-02&
			,  4.23833728E-02,  3.69166918E-02,  2.46214997E-02,  1.46459257E-02,  1.96592286E-02,  1.31775625E-02&
			,  1.88483559E-02,  1.73293538E-02,  1.19389575E-02,  2.34892010E-03,  8.19902925E-04/)
CovTa(6,:)=(/  8.88476241E-03,  0.127838865   ,  0.186129585   ,  0.282379299   ,  0.494835794   ,  0.711149216   &
			,  0.417884320   ,  0.226387411   ,  0.148527816   ,  0.115779042   ,  0.102436244   ,  9.17016789E-02&
			,  8.79363194E-02,  8.89787525E-02,  7.55947977E-02,  6.68265969E-02,  5.90198524E-02,  5.29730730E-02&
			,  4.72761691E-02,  3.90459709E-02,  2.22867727E-02,  1.17143709E-02,  1.39258262E-02,  1.03371143E-02&
			,  2.00291164E-02,  1.36048123E-02,  9.15028434E-03, -1.68011419E-03, -2.57799664E-04/)
CovTa(7,:)=(/ -2.78132949E-02,  9.13718566E-02,  0.117249288   ,  0.153259307   ,  0.245371550   ,  0.417884320   &
			,  0.629249573   ,  0.382368773   ,  0.225068018   ,  0.154718444   ,  0.123704664   ,  0.102491006   &
			,  9.53407511E-02,  9.52663049E-02,  8.12073573E-02,  7.26902038E-02,  6.48870021E-02,  5.75720556E-02&
			,  4.88995016E-02,  4.02634479E-02,  2.37385668E-02,  1.37189692E-02,  1.50084710E-02,  1.00145359E-02&
			,  1.77307650E-02,  1.03296647E-02,  1.11361817E-02, -3.00694373E-03,  1.74049474E-03/)
CovTa(8,:)=(/ -4.53510694E-02,  7.35643208E-02,  9.06797498E-02,  0.108485878   ,  0.145605281   ,  0.226387411   &
			,  0.382368773   ,  0.614543796   ,  0.410460055   ,  0.247611612   ,  0.173788339   ,  0.120830469   &
			,  0.107953049   ,  0.105580062   ,  9.41645503E-02,  8.27038512E-02,  7.56751895E-02,  6.69221431E-02&
			,  5.95816001E-02,  4.78495322E-02,  3.10382210E-02,  1.88443176E-02,  1.97465364E-02,  1.32968705E-02&
			,  1.95497479E-02,  1.29204979E-02,  1.25680957E-02, -9.41305654E-04,  5.12505369E-03/)
CovTa(9,:)=(/ -4.26108539E-02,  6.96875006E-02,  8.20079744E-02,  9.26147476E-02,  0.109592997   ,  0.148527816   &
			,  0.225068018   ,  0.410460055   ,  0.629807234   ,  0.419666141   ,  0.260086060   ,  0.145873085   &
			,  0.120191723   ,  0.115612060   ,  0.104551673   ,  9.27856788E-02,  8.59029666E-02,  7.68282786E-02&
			,  7.09968582E-02,  5.50563633E-02,  3.53485160E-02,  2.04140414E-02,  2.12238766E-02,  1.82359572E-02&
			,  2.21165437E-02,  1.82059370E-02,  1.13922665E-02,  2.10698484E-03,  6.42194925E-03/)
CovTa(10,:)=(/-2.61215754E-02,  6.96579888E-02,  7.95532167E-02,  8.61303136E-02,  9.35356691E-02,  0.115779042   &
			,  0.154718444   ,  0.247611612   ,  0.419666141   ,  0.622414589   ,  0.422831684   ,  0.180508882   &
			,  0.133526057   ,  0.126950040   ,  0.115609914   ,  0.102724768   ,  9.64435637E-02,  8.54182541E-02&
			,  8.12304765E-02,  6.20152466E-02,  4.04078625E-02,  2.40771789E-02,  2.57072188E-02,  2.50293389E-02&
			,  2.80334763E-02,  2.57822964E-02,  1.35728093E-02,  5.63952699E-03,  4.76139318E-03/)
CovTa(11,:)=(/-2.76487917E-02,  7.03774244E-02,  7.75735676E-02,  8.26010928E-02,  8.83718729E-02,  0.102436244   &
			,  0.123704664   ,  0.173788339   ,  0.260086060   ,  0.422831684   ,  0.592847049   ,  0.243542328   &
			,  0.154603377   ,  0.141900331   ,  0.128723711   ,  0.115184568   ,  0.107600659   ,  9.43833217E-02&
			,  9.03835818E-02,  7.00369924E-02,  4.34860438E-02,  2.85033043E-02,  2.67436840E-02,  2.68095639E-02&
			,  3.01799998E-02,  2.81585045E-02,  1.74438562E-02,  1.02525419E-02,  8.31584167E-03/)
CovTa(12,:)=(/-2.51980964E-02,  6.58064261E-02,  7.15421513E-02,  7.74837881E-02,  8.14356878E-02,  9.17016789E-02&
			,  0.102491006   ,  0.120830469   ,  0.145873085   ,  0.180508882   ,  0.243542328   ,  0.528013349   &
			,  0.243497863   ,  0.182609305   ,  0.157756194   ,  0.141839713   ,  0.132277250   ,  0.118195884   &
			,  0.108922839   ,  8.48401785E-02,  5.20943403E-02,  3.54857966E-02,  2.93007363E-02,  3.00474651E-02&
			,  3.34464312E-02,  2.96306144E-02,  2.04831548E-02,  1.51489982E-02,  1.29931336E-02/)
CovTa(13,:)=(/-1.61948316E-02,  6.86929151E-02,  7.28158727E-02,  7.73731545E-02,  7.95709193E-02,  8.79363194E-02&
			,  9.53407511E-02,  0.107953049   ,  0.120191723   ,  0.133526057   ,  0.154603377   ,  0.243497863   &
			,  0.538356960   ,  0.304456830   ,  0.212505326   ,  0.175656393   ,  0.166275650   ,  0.149789065   &
			,  0.141269818   ,  0.109304972   ,  6.68096468E-02,  4.43648919E-02,  3.75361294E-02,  3.44885811E-02&
			,  4.10235152E-02,  3.63588519E-02,  2.44249981E-02,  1.38488756E-02,  1.16981771E-02/)
CovTa(14,:)=(/ 8.63474421E-03,  7.39764795E-02,  7.58946165E-02,  7.70609304E-02,  7.70259723E-02,  8.89787525E-02&
			,  9.52663049E-02,  0.105580062   ,  0.115612060   ,  0.126950040   ,  0.141900331   ,  0.182609305   &
			,  0.304456830   ,  0.563420832   ,  0.320859909   ,  0.222902179   ,  0.205602020   ,  0.187223122   &
			,  0.177845180   ,  0.139530420   ,  8.71966034E-02,  5.77841997E-02,  4.43557352E-02,  3.69862355E-02&
			,  4.50172387E-02,  4.26585153E-02,  2.58752778E-02,  1.86738353E-02,  1.50324106E-02/)
CovTa(15,:)=(/ 2.49303319E-03,  5.54191321E-02,  5.75700328E-02,  6.09061159E-02,  6.47098124E-02,  7.55947977E-02&
			,  8.12073573E-02,  9.41645503E-02,  0.104551673   ,  0.115609914   ,  0.128723711   ,  0.157756194   &
			,  0.212505326   ,  0.320859909   ,  0.535067856   ,  0.298108935   ,  0.249107242   ,  0.230787918   &
			,  0.217806265   ,  0.172050238   ,  0.105653808   ,  6.98188096E-02,  4.61264066E-02,  3.86381969E-02&
			,  4.34098057E-02,  4.24456373E-02,  3.15519311E-02,  2.46784259E-02,  2.07029544E-02/)
CovTa(16,:)=(/ 1.11986129E-02,  4.47899513E-02,  4.88301404E-02,  5.26640490E-02,  5.74070662E-02,  6.68265969E-02&
			,  7.26902038E-02,  8.27038512E-02,  9.27856788E-02,  0.102724768   ,  0.115184568   ,  0.141839713   &
			,  0.175656393   ,  0.222902179   ,  0.298108935   ,  0.512680709   ,  0.323541731   ,  0.286791831   &
			,  0.258769661   ,  0.209725350   ,  0.128698304   ,  8.49350914E-02,  5.49244694E-02,  3.95102762E-02&
			,  4.54419143E-02,  4.79389094E-02,  3.70778106E-02,  2.99828518E-02,  2.70373821E-02/)
CovTa(17,:)=(/ 7.41162617E-03,  4.12805788E-02,  4.19575870E-02,  4.61906530E-02,  5.26588336E-02,  5.90198524E-02&
			,  6.48870021E-02,  7.56751895E-02,  8.59029666E-02,  9.64435637E-02,  0.107600659   ,  0.132277250   &
			,  0.166275650   ,  0.205602020   ,  0.249107242   ,  0.323541731   ,  0.560468078   ,  0.366603404   &
			,  0.316764146   ,  0.255695522   ,  0.161818758   ,  0.105625585   ,  5.94182350E-02,  4.37996723E-02&
			,  4.90267053E-02,  5.32087982E-02,  4.36086021E-02,  3.70668732E-02,  2.88219098E-02/)
CovTa(18,:)=(/ 5.14982175E-03,  3.40297036E-02,  3.64593044E-02,  4.12034169E-02,  4.73134257E-02,  5.29730730E-02&
			,  5.75720556E-02,  6.69221431E-02,  7.68282786E-02,  8.54182541E-02,  9.43833217E-02,  0.118195884   &
			,  0.149789065   ,  0.187223122   ,  0.230787918   ,  0.286791831   ,  0.366603404   ,  0.570268095   &
			,  0.403077573   ,  0.318518877   ,  0.204907149   ,  0.131682515   ,  7.41756856E-02,  4.58139926E-02&
			,  5.36192581E-02,  6.01239689E-02,  5.20436764E-02,  4.94452976E-02,  4.12326306E-02/)
CovTa(19,:)=(/ 2.45501362E-02,  3.17294337E-02,  3.16226184E-02,  3.66913788E-02,  4.23833728E-02,  4.72761691E-02&
			,  4.88995016E-02,  5.95816001E-02,  7.09968582E-02,  8.12304765E-02,  9.03835818E-02,  0.108922839   &
			,  0.141269818   ,  0.177845180   ,  0.217806265   ,  0.258769661   ,  0.316764146   ,  0.403077573   &
			,  0.667497277   ,  0.418587357   ,  0.263102829   ,  0.170787916   ,  9.03624743E-02,  5.65460399E-02&
			,  6.35292605E-02,  7.58273602E-02,  7.01784715E-02,  5.79069369E-02,  4.97621894E-02/)
CovTa(20,:)=(/ 2.83700321E-02,  2.92330757E-02,  3.30184996E-02,  3.54958214E-02,  3.69166918E-02,  3.90459709E-02&
			,  4.02634479E-02,  4.78495322E-02,  5.50563633E-02,  6.20152466E-02,  7.00369924E-02,  8.48401785E-02&
			,  0.109304972   ,  0.139530420   ,  0.172050238   ,  0.209725350   ,  0.255695522   ,  0.318518877   &
			,  0.418587357   ,  0.666850448   ,  0.357438684   ,  0.234326899   ,  0.128581822   ,  6.75302967E-02&
			,  7.51187876E-02,  8.96755010E-02,  8.80818143E-02,  6.96276948E-02,  5.63731343E-02/)
CovTa(21,:)=(/ 3.92710082E-02,  1.83074195E-02,  2.48787012E-02,  2.55120136E-02,  2.46214997E-02,  2.22867727E-02&
			,  2.37385668E-02,  3.10382210E-02,  3.53485160E-02,  4.04078625E-02,  4.34860438E-02,  5.20943403E-02&
			,  6.68096468E-02,  8.71966034E-02,  0.105653808   ,  0.128698304   ,  0.161818758   ,  0.204907149   &
			,  0.263102829   ,  0.357438684   ,  0.739322245   ,  0.408542216   ,  0.217559636   ,  0.112321325   &
			,  0.103566647   ,  0.118382595   ,  0.115994841   ,  9.40659493E-02,  8.25269595E-02/)
CovTa(22,:)=(/ 5.01138568E-02,  1.55186374E-02,  1.82592180E-02,  1.90115552E-02,  1.46459257E-02,  1.17143709E-02&
			,  1.37189692E-02,  1.88443176E-02,  2.04140414E-02,  2.40771789E-02,  2.85033043E-02,  3.54857966E-02&
			,  4.43648919E-02,  5.77841997E-02,  6.98188096E-02,  8.49350914E-02,  0.105625585   ,  0.131682515   &
			,  0.170787916   ,  0.234326899   ,  0.408542216   ,  0.840451181   ,  0.346454799   ,  0.163101345   &
			,  0.131323293   ,  0.132569298   ,  0.138390839   ,  0.123464964   ,  0.112081468   /)
CovTa(23,:)=(/ 0.107088841   ,  3.03882044E-02,  2.82323342E-02,  2.54305564E-02,  1.96592286E-02,  1.39258262E-02&
			,  1.50084710E-02,  1.97465364E-02,  2.12238766E-02,  2.57072188E-02,  2.67436840E-02,  2.93007363E-02&
			,  3.75361294E-02,  4.43557352E-02,  4.61264066E-02,  5.49244694E-02,  5.94182350E-02,  7.41756856E-02&
			,  9.03624743E-02,  0.128581822   ,  0.217559636   ,  0.346454799   ,  0.853161812   ,  0.295257062   &
			,  0.197243676   ,  0.169427469   ,  0.176014140   ,  0.153336078   ,  0.136484653   /)
CovTa(24,:)=(/ 0.100456975   ,  2.66580451E-02,  2.16992702E-02,  1.58545747E-02,  1.31775625E-02,  1.03371143E-02&
			,  1.00145359E-02,  1.32968705E-02,  1.82359572E-02,  2.50293389E-02,  2.68095639E-02,  3.00474651E-02&
			,  3.44885811E-02,  3.69862355E-02,  3.86381969E-02,  3.95102762E-02,  4.37996723E-02,  4.58139926E-02&
			,  5.65460399E-02,  6.75302967E-02,  0.112321325   ,  0.163101345   ,  0.295257062   ,  0.970320046   &
			,  0.334437847   ,  0.238041669   ,  0.245253861   ,  0.239946127   ,  0.212519601   /)
CovTa(25,:)=(/ 0.118547171   ,  2.91927252E-02,  2.65046470E-02,  1.85802374E-02,  1.88483559E-02,  2.00291164E-02&
			,  1.77307650E-02,  1.95497479E-02,  2.21165437E-02,  2.80334763E-02,  3.01799998E-02,  3.34464312E-02&
			,  4.10235152E-02,  4.50172387E-02,  4.34098057E-02,  4.54419143E-02,  4.90267053E-02,  5.36192581E-02&
			,  6.35292605E-02,  7.51187876E-02,  0.103566647   ,  0.131323293   ,  0.197243676   ,  0.334437847   &
			,  0.890429378   ,  0.392451674   ,  0.333345354   ,  0.312197208   ,  0.273458064   /)
CovTa(26,:)=(/ 0.144162372   ,  3.36599872E-02,  2.54206229E-02,  2.00621523E-02,  1.73293538E-02,  1.36048123E-02&
			,  1.03296647E-02,  1.29204979E-02,  1.82059370E-02,  2.57822964E-02,  2.81585045E-02,  2.96306144E-02&
			,  3.63588519E-02,  4.26585153E-02,  4.24456373E-02,  4.79389094E-02,  5.32087982E-02,  6.01239689E-02&
			,  7.58273602E-02,  8.96755010E-02,  0.118382595   ,  0.132569298   ,  0.169427469   ,  0.238041669   &
			,  0.392451674   ,  1.17382777    ,  0.480109394   ,  0.416648507   ,  0.378189683   /)
CovTa(27,:)=(/ 0.130702093   ,  1.78863201E-02,  1.53768435E-02,  1.07287532E-02,  1.19389575E-02,  9.15028434E-03&
			,  1.11361817E-02,  1.25680957E-02,  1.13922665E-02,  1.35728093E-02,  1.74438562E-02,  2.04831548E-02&
			,  2.44249981E-02,  2.58752778E-02,  3.15519311E-02,  3.70778106E-02,  4.36086021E-02,  5.20436764E-02&
			,  7.01784715E-02,  8.80818143E-02,  0.115994841   ,  0.138390839   ,  0.176014140   ,  0.245253861   &
			,  0.333345354   ,  0.480109394   ,  1.41659331    ,  0.499717802   ,  0.468229145   /)
CovTa(28,:)=(/ 0.105246171   ,  1.91269591E-02,  1.14704622E-02,  2.76555819E-03,  2.34892010E-03, -1.68011419E-03&
			, -3.00694373E-03, -9.41305654E-04,  2.10698484E-03,  5.63952699E-03,  1.02525419E-02,  1.51489982E-02&
			,  1.38488756E-02,  1.86738353E-02,  2.46784259E-02,  2.99828518E-02,  3.70668732E-02,  4.94452976E-02&
			,  5.79069369E-02,  6.96276948E-02,  9.40659493E-02,  0.123464964   ,  0.153336078   ,  0.239946127   &
			,  0.312197208   ,  0.416648507   ,  0.499717802   ,  1.75652397    ,  0.504000247   /)
CovTa(29,:)=(/ 7.98874274E-02,  2.31658760E-02,  1.26516288E-02,  1.64459751E-03,  8.19902925E-04, -2.57799664E-04&
			,  1.74049474E-03,  5.12505369E-03,  6.42194925E-03,  4.76139318E-03,  8.31584167E-03,  1.29931336E-02&
			,  1.16981771E-02,  1.50324106E-02,  2.07029544E-02,  2.70373821E-02,  2.88219098E-02,  4.12326306E-02&
			,  4.97621894E-02,  5.63731343E-02,  8.25269595E-02,  0.112081468   ,  0.136484653   ,  0.212519601   &
			,  0.273458064   ,  0.378189683   ,  0.468229145   ,  0.504000247   ,  1.65901506    /) 

!! we found the covariance is upside down, but I don't want to reorgnize them again, too much....
CovTa1=CovTa
CovQw1=CovQw
do ilevel=1,nlevel
	do jlevel=1,nlevel
		CovTa(ilevel,jlevel)=CovTa1(nlevel-ilevel+1,nlevel-jlevel+1)
		CovQw(ilevel,jlevel)=CovQw1(nlevel-ilevel+1,nlevel-jlevel+1)
	end do
end do

!!! transform matrix of 29 level specific humidity to 8 mode EOFs space.
UQw(1,:) =(/-0.000382063, -0.0011944,   -0.000421503, 0.00222746, -8.01516e-05,  0.00198589,  2.10826e-05, 0.00136297 /)
UQw(2,:) =(/-0.000322739, -0.000942002, -0.000407001, 0.00167294, -4.52086e-05,  0.00139327,  0.00015866,  0.000942571/)
UQw(3,:) =(/-0.0002227,   -0.00076239,  -0.000307406, 0.00153383, -2.2678e-05 ,  0.00139612,  0.000112131, 0.000903424/)
UQw(4,:) =(/-0.000214324, -0.000656969, -0.000318945, 0.00168168, -0.000170118,  0.00186946, -6.78564e-05, 0.00122322 /)
UQw(5,:) =(/-0.000205119, -0.000550905, -0.000330877, 0.00186381, -0.000326106,  0.00240173, -0.000259811, 0.00151051 /)
UQw(6,:) =(/-0.000371955, -0.000328094, -0.000444385, 0.00181253, -0.000709763,  0.00310451, -0.000641186, 0.00183901 /)
UQw(7,:) =(/-0.000527743, -0.000136891, -0.000664184, 0.00167169, -0.00125587 ,  0.00385525, -0.00128532,  0.00200018 /)
UQw(8,:) =(/-0.00134473,   0.000476538, -0.000779512, 0.00146731, -0.00189408 ,  0.00507916, -0.00210066,  0.00237257 /)
UQw(9,:) =(/-0.00225696,   0.00100894,  -0.00116727,  0.00145853, -0.00262842 ,  0.00672413, -0.00297796,  0.00292997 /)
UQw(10,:)=(/-0.00545306,   0.00315655,  -0.00149117,  0.00185868, -0.00479306 ,  0.0130594 , -0.00629711,  0.00596942 /)
UQw(11,:)=(/-0.0101585,	   0.00579279,  -0.00202561,  0.00261523, -0.00820546 ,  0.0225691 , -0.010501,	   0.0111852  /)
UQw(12,:)=(/-0.0160152,    0.00853757,  -0.00481002,  0.00542158, -0.013793,	 0.035651  , -0.0181493,   0.0189666  /)
UQw(13,:)=(/-0.0236797,    0.0134041,   -0.00673347,  0.00958556, -0.02331,		 0.0587257 , -0.032474,	   0.0312095  /)
UQw(14,:)=(/-0.0331282,    0.0187954,   -0.0101658,   0.016847,   -0.0311726,	 0.0920663 , -0.0533986,   0.0547974  /)
UQw(15,:)=(/-0.0456509,    0.0272957,	-0.0234686,	  0.0306448,  -0.0579131,	 0.180978  , -0.108095,	   0.123951   /)
UQw(16,:)=(/-0.0618832,    0.038248, 	-0.0327996,	  0.0478157,  -0.0992585,	 0.318007  , -0.20002,	   0.201904   /)
UQw(17,:)=(/-0.075952, 	   0.0565012,	-0.0516306,	  0.0684709,  -0.159041 ,	 0.481706  , -0.310538,	   0.187812   /)
UQw(18,:)=(/-0.0956353,    0.0832958,   -0.0944699,	  0.112994,	  -0.241007 ,	 0.496577  , -0.210223,	  -0.191104   /)
UQw(19,:)=(/-0.152589, 	   0.181329, 	-0.260879,	  0.305284,	  -0.385829 ,	 0.0360549 ,  0.383291,	  -0.363767   /)
UQw(20,:)=(/-0.18948, 	   0.239241, 	-0.350178,	  0.325755,	  -0.218995 ,   -0.228133  ,  0.202695,	   0.113356   /)
UQw(21,:)=(/-0.216979, 	   0.270849, 	-0.357725,	  0.156655,	   0.183744 ,   -0.290591  , -0.276031,	   0.370309   /)
UQw(22,:)=(/-0.235571, 	   0.275168, 	-0.264766,	 -0.132258,	   0.441886 ,   -0.0323578 , -0.30012,	  -0.161138   /)
UQw(23,:)=(/-0.25334,	   0.26306, 	-0.0930911,	 -0.383584,	   0.290542 ,	 0.228428  ,  0.19977,	  -0.391783   /)
UQw(24,:)=(/-0.276708,	   0.236423, 	 0.118606,	 -0.439726,	  -0.118184 ,	 0.117428  ,  0.360138,	   0.252674   /)
UQw(25,:)=(/-0.300529,	   0.186882,     0.297408,	 -0.266558,	  -0.352347 ,   -0.172368  , -0.0233421,   0.303934   /)
UQw(26,:)=(/-0.321221,	   0.0962831, 	 0.407768,	  0.0652105,  -0.226322 ,   -0.284606  , -0.391776,	  -0.306358   /)
UQw(27,:)=(/-0.351273, 	  -0.0417583, 	 0.376112,	  0.361975,	   0.204157 ,	 0.00470931, -0.0269605,  -0.222274   /)
UQw(28,:)=(/-0.368859, 	  -0.197489, 	 0.204496,	  0.36191,	   0.372475 ,	 0.224741  ,  0.344113,	   0.320126   /)
UQw(29,:)=(/-0.470805,	  -0.733332,    -0.370288,	 -0.244381,	  -0.146931 ,   -0.0863411 , -0.078964,	  -0.0618466  /)

!!! transform matrix of 29 level Atmos. Temperatures to 8 mode EOFs space.
UTa(1,:) =(/0.0149302,    -0.286014,    -0.323548,   -0.192165,   0.139185,      0.326712,    0.710704,    -0.243499 /)
UTa(2,:) =(/0.0183128, 	  -0.315065,    -0.357322,   -0.200524,   0.137529,      0.337416,   -0.69991,     -0.177038 /)
UTa(3,:) =(/0.0207268,    -0.293733,    -0.297779,   -0.136351,   0.0659396,    -0.0838554,   0.0469805,    0.146221 /)
UTa(4,:) =(/0.0217665,    -0.264621,    -0.237288,   -0.0937236,  0.025914,     -0.135942,    0.0130143,    0.190574 /)
UTa(5,:) =(/0.017838,     -0.215408,    -0.172634,   -0.0524914, -0.00861389,   -0.21971,    -0.00374445,   0.180668 /)
UTa(6,:) =(/0.015348,     -0.189795,    -0.144772,   -0.0212017, -0.0708476,    -0.347084,   -0.000247551,  0.191696 /)
UTa(7,:) =(/0.0154779,    -0.17497,     -0.089331,    0.0580572, -0.176967,     -0.38068,     0.00618015,   0.0486453/)
UTa(8,:) =(/0.00889305,   -0.182239,    -0.0574056,   0.144969,  -0.255783,     -0.299056,    0.00797026,  -0.0892459/)
UTa(9,:) =(/0.00749889,   -0.188205,    -0.0157274,   0.197051,  -0.248375,     -0.157814,    0.00330338,  -0.126616 /)
UTa(10,:)=(/0.00618245,   -0.196505,     0.0373657,   0.248955,  -0.206154,	     0.0337273,  -0.00328084,  -0.130316 /)
UTa(11,:)=(/0.00560058,   -0.200446,     0.063263,    0.271728,  -0.166131,      0.12366,    -0.00181609,  -0.110512 /)
UTa(12,:)=(/0.00339125,   -0.186522,     0.0753541,   0.251079,  -0.122112,      0.149602,   -0.00321952,  -0.081861 /)
UTa(13,:)=(/0.00354892,   -0.177362,     0.0872268,   0.234433,  -0.0816924,     0.160387,   -0.00362311,  -0.0432113/)
UTa(14,:)=(/0.00386561,   -0.166196,     0.092876,    0.207873,  -0.0422353,     0.15421,     3.51761e-06, -0.0122307/)
UTa(15,:)=(/0.00308097,   -0.162499,     0.105077,    0.189266,  -0.0024944,     0.15584,    -0.000386532,  0.0306434/)
UTa(16,:)=(/0.00401407,   -0.158886,     0.117453,    0.161364,   0.0332378,     0.14119,     7.99292e-05,  0.0694412/)
UTa(17,:)=(/0.00117156,   -0.142644,     0.113651,    0.129677,   0.0658885,     0.110437,    0.00148544,   0.0940696/)
UTa(18,:)=(/-2.2904e-05,  -0.130245,     0.113593,    0.100287,   0.120182,      0.0720442,   0.00283088,   0.131698 /)
UTa(19,:)=(/-0.000320684, -0.136192,     0.136455,    0.0879394,  0.23614,       0.0192582,   0.00729063,   0.236916 /)
UTa(20,:)=(/-0.000259333, -0.139423,     0.150748,    0.0807607,  0.300276,     -0.0199461,   0.00965807,   0.258696 /)
UTa(21,:)=(/-0.0019749,   -0.137307,     0.159994,    0.0605051,  0.33102,      -0.0637629,   0.0117138,    0.189442 /)
UTa(22,:)=(/-0.00203511,  -0.132027,     0.165192,    0.0267856,  0.318808,     -0.112327,    0.00721207,   0.0447181/)
UTa(23,:)=(/0.000566985,  -0.128679,     0.177913,   -0.0271136,  0.275113,     -0.159592,   -0.00422665,  -0.152187 /)
UTa(24,:)=(/0.00616187,   -0.139346,     0.209848,   -0.102015,   0.206365,     -0.196505,   -0.0186885,   -0.338977 /)
UTa(25,:)=(/0.0155251,    -0.153038,     0.246914,   -0.201345,   0.0749661,    -0.178897,   -0.0264622,   -0.399498 /)
UTa(26,:)=(/0.0313577,    -0.166446,     0.286022,   -0.304631,  -0.105698,     -0.0737946,  -0.018611,    -0.235508 /)
UTa(27,:)=(/0.0619927,    -0.171606,     0.30319,    -0.377319,  -0.269467,      0.090234,    0.00418383,   0.106371 /)
UTa(28,:)=(/0.133013,     -0.149071,     0.275742,   -0.360636,  -0.332127,      0.220095,    0.0265447,    0.397965 /)
UTa(29,:)=(/0.987253,      0.0793131,   -0.0418795,   0.0881041,  0.0683952,    -0.0202147,  -0.0017761,   -0.0478213/)
  


!! However, due to the terrial height, bottom layers are often burried beneath the surface thus not approprite to be included in 
!! RTTOV forward simulation.

!! Determine the layer number:  
  CALL DeterminNlayEff(nlevel,PLEVEL,SfcPress,nLayEff)
  
!! modified Covar of bottom layers 
  CALL DisabLayBelowSfc(nlevel,nLayEff,CovQw)
  CALL DisabLayBelowSfc(nlevel,nLayEff,CovTa)
  UQw(nLayEff+1:nlevel,:)=0.
  UTa(nLayEff+1:nlevel,:)=0.
  
!! transform to Covars in EOF space
  CALL ProjCov(nEOF,nlevel,UQw,CovQw,LambdaQw)
  CALL ProjCov(nEOF,nlevel,UTa,CovTa,LambdaTa)

!! idealy, If Ta and Qw are all full rank, the eigenvalue diagnal matrix will be :
!! these diagnal values are principle components of EOF space,  we gona use them as the error covariance matrix in EOF space.
!! pcvar :(30.58026, 17.67337, 11.69979, 8.050688, 5.817812, 4.843317, 3.952374, 2.973315 ) %
! LambdaQW(1,:)=(/3.710733e-06,0.,0.,0.,0.,0.,0.,0./)
! LambdaQW(2,:)=(/0.,2.144559e-06,0.,0.,0.,0.,0.,0./)
! LambdaQW(3,:)=(/0.,0.,1.4197e-06,0.,0.,0.,0.,0./)
! LambdaQW(4,:)=(/0.,0.,0.,9.769033e-07,0.,0.,0.,0./)
! LambdaQW(5,:)=(/0.,0.,0.,0.,7.059569e-07,0.,0.,0./)
! LambdaQW(6,:)=(/0.,0.,0.,0.,0.,5.877077e-07,0.,0./)
! LambdaQW(7,:)=(/0.,0.,0.,0.,0.,0.,4.795971e-07,0./)
! LambdaQW(8,:)=(/0.,0.,0.,0.,0.,0.,0.,3.607942e-07/)

! pcvar :(29.69952, 11.34457, 9.393681, 6.925895, 4.883001, 3.886191, 3.609612, 3.441968 ) %
! LambdaTA(1,:)=(/9.89189,0.,0.,0.,0.,0.,0.,0./)
! LambdaTA(2,:)=(/0.,3.778485,0.,0.,0.,0.,0.,0./)
! LambdaTA(3,:)=(/0.,0.,3.128712,0.,0.,0.,0.,0./)
! LambdaTA(4,:)=(/0.,0.,0.,2.306777,0.,0.,0.,0./)
! LambdaTA(5,:)=(/0.,0.,0.,0.,1.626359,0.,0.,0./)
! LambdaTA(6,:)=(/0.,0.,0.,0.,0.,1.294356,0.,0./)
! LambdaTA(7,:)=(/0.,0.,0.,0.,0.,0.,1.202237,0./)
! LambdaTA(8,:)=(/0.,0.,0.,0.,0.,0.,0.,1.146401/)


Utotal=0.0
Utotal(1:29,1:8)=UTa
Utotal(30:58,9:16)=UQw
Utotal(59:59,17:17)=1.0   !! LST
Utotal(60:68,18:26)=Uem   !! emissivity

Lambda=0.0
Lambda(1:8,1:8)=LambdaTA
Lambda(9:16,9:16)=LambdaQW
Lambda(17,17)=12.773  !! k*k   Stdev^2 
Lambda(18:26,18:26)=LambdaEM

!!! perform a inital clear sky forward modeling to get the emissivity 1st guess, and analytical emissivity solution.
CALL rttov_fwd_clearsky(imonth,nLayEff,nchannel,incident,longitude,latitude,plevel(1:nLayEff),phalf(1:nLayEff),&
  				QWatm(1:nLayEff),Tatm(1:nLayEff),LST,SfcPress,T2m,Snowc,Smc,TBobs,EmissAnalyt,Emiss1st)
 
LstTune	=	LST
TbTune	=	TBobs
nIters	=	0				

Xg=0.0
Xg(1:nLayEff)=Tatm(1:nLayEff)
Xg(nlevel+1:nlevel+nLayEff)=QWatm(1:nLayEff)
Xg(nlevel+nlevel+1)=LstTune
Xg(nlevel+nlevel+2:nlevel+nlevel+10)=Emiss1st
Xb=Xg

Ja=0.0

DO WHILE (.True.)
	nIters=nIters+1

	! input emissin, Tatm, QWatm,
	! output jacobian matrix	
	CALL rttov_fwd_jacobian(nLayEff,nchannel,incident,plevel(1:nLayEff),&
				  Xg(nlevel+1:nlevel+nLayEff),Xg(1:nLayEff),Xg(nlevel+nlevel+1),T2m,Xg(nlevel+nlevel+2:nlevel+nlevel+10),&
				  TbTune,Emss_K,&
				  Ja(:, 1:nLayEff),Ja(:, nlevel+1:nlevel+nLayEff),Ja(:, nlevel+nlevel+1))
				  
    ! Ja(:, 1:nLayEff)=Ta_K(:,1:nLayEff)
    ! Ja(:, nlevel+1:nlevel+nLayEff)=Qw_K(:,1:nLayEff)
    ! Ja(:, nlevel+nlevel+1)=LST_K
	
	do ich=1,nchannel
		Ja(nlevel+nlevel+1+ich, nlevel+nlevel+1+ich)=Emss_K(ich)
	end do
		
	!! check for convergence 
	CALL Convgce(nchannel,TBobs,TbTune,EY,ChiSq,CvgceReached,ChiSqThresh,dY2)
	print*, nIters, ChiSq, dY2
	IF (CvgceReached) GOTO 221  


	!! compute departures of Geoproperties
	DX = Xg - Xb
	
	!---Transform K and DX into EOF space
	Ktilda  = matmul(Ja,Utotal)
    DXtilda = matmul(transpose(Utotal),DX)
	
    !---Compute the Levenberg-Marquardt optimal solution 
	
    Q = MATMUL(dble(Ja),MATMUL(dble(Lambda),TRANSPOSE(dble(Ja))))
    Q = dble(LambdaTB) + Q
    Q = MATINV_dbl(Q)
    G = REAL(MATMUL(dble(Lambda),MATMUL(TRANSPOSE(dble(Ja)),Q)))
	
    B=(TBobs-TbTune+matmul(Ktilda,DXtilda))
    DXtildaNew = matmul(G,B)	

	REAL*8, dimension(nchannel,nchannel) :: Q
	REAL, dimension(26,nchannel) :: G
	REAL,    DIMENSION(nch)      :: B
	REAL,    DIMENSION(nchannel) ::DXtildaNew, DXtilda
	REAL,    DIMENSION(nchannel,26) :: Ktilda
	REAL,    DIMENSION(26) :: DXtilda

    ! call CompContribFcts_dbl(nR,nch,Lambda,Ktilda,SeStar+FeStar,G)
  ! SUBROUTINE CompContribFcts_dbl(np,nc,Sa,K,Serr,G)
    ! ---Input/Output variables
    ! INTEGER                :: np,nc
    ! REAL, DIMENSION(:,:)   :: Sa,K,Serr,G
    ! ---Local variables
    ! REAL(SELECTED_REAL_KIND(15) ), DIMENSION(nc,nc) :: Q
    
    ! Q(1:nc,1:nc) = MATMUL(dble(K),MATMUL(dble(Sa),TRANSPOSE(dble(K))))
    ! Q(1:nc,1:nc) = dble(Serr(1:nc,1:nc)) + Q(1:nc,1:nc)
    ! Q(1:nc,1:nc) = MATINV_dbl(Q(1:nc,1:nc))
    ! G(1:np,1:nc) = REAL(MATMUL(dble(Sa),MATMUL(TRANSPOSE(dble(K)),Q)))
    ! RETURN
  ! END SUBROUTINE CompContribFcts_dbl




		
    !---Transform DXtildaNew into Geophysical space
    call transfEOF2Geo(Ustar(1:nGselec,1:nR),DXtildanew(1:nR),DX(1:nGselec), nGselec,nR)
	   
    !---Compute geophysical vector 
    call ComputeGeoX(DX(1:nGselec),Xb(1:nGselec),Xg(1:nGselec,iter+1))
    
	
	
	
		! open(10,file="1st_iter_params.md")
		! Write(10,*) '## nLayEff = ',nLayEff,' '
		! Write(10,*) '| Emiss TELSEM  |  Emiss Analytical  |  TbTune (K)  |  TBobs (K) |  '
		! Write(10,*) '|:-------|:-------|:-------|:-------|  '
		! do ich=1,9
			! Write(10,*)'| ', Emiss1st(ich),'| ',EmissAnalyt(ich),'| ',TbTune(ich),'| ',TBobs(ich),' |  '
		! end do
		! Write(10,*) '--- ' 
		! Write(10,*) '| Emss_K (K/ )  |    LST_K (K/K) |  '
			! Write(10,*) '|:-------|:-------|  '
		! do ich=1,9
			! Write(10,*) '| ',Emss_K(ich),'| ',LST_K(ich),' | '
		! end do		
		! do ifr=1,9
			! Write(10,*) '--- ' 
			! Write(10,*) '## CH:' ,ifr
			! Write(10,*) '| Ta_K (K/K) |   Qw_K (K/(kg/kg) |  '
			! Write(10,*) '|:-------|:-------|  '
			! do ilv=1,29
				! Write(10,*) '| ',Ta_K(ifr,ilv),' | ',Qw_K(ifr,ilv),' |  '
			! end do
		! end do
		! close(10)
	
	!! decide the chisq -- the criterion of Iteration stop

	!! transform Jacobians to EOF space
	!! compute DX in EOF space
	!! DXTilda

	!! project to geophysical states space
	!! DX=U#DXTilda

	!! update Update Ta, Qw, Em, LST in GEO space

	IF (nIters.ge.20) GOTO 221 
END DO


221 continue		
! return EmissAnalyt,Emiss1st,Em1DVar,LstTune,nIters
stop 

end subroutine retrieve_core_1dvar

SUBROUTINE DeterminNlayEff(nLay,pres_lay,SfcPress,nLayEff)
  INTEGER               :: nLay,nLayEff,i
  REAL                  :: SfcPress
  REAL,    DIMENSION(nLay) :: pres_lay
  nLayEff=0
  Do i=1,nLay
     IF (pres_lay(i).le.SfcPress .and. SfcPress/pres_lay(i).gt.1.01) THEN
        nLayEff = nLayEff + 1
     ENDIF
  ENDDO
  RETURN
END SUBROUTINE DeterminNlayEff

SUBROUTINE DisabLayBelowSfc(nLay,nLayEff,SaAtm)
  REAL, DIMENSION(nLay,nLay) :: SaAtm
  REAl                 :: SfcPress
  INTEGER              :: nLayEff,i,nLay,iattempt
  !---Disable retrieval of below-sfc layers by setting covar to high value and decorrel.
  !! TOA(1) -> srf(nLayEff) -> bottom (nLay)
  !! decorrel.
  SaAtm(nLayEff+1:nLay,:)  =0.
  SaAtm(:,nLayEff+1:nLay)  =0.
  !! covar to high value
  Do i=nLayEff+1,nLay
     SaAtm(i,i) =0.   
	 !! The source code of MIRS set it to 0., shouldnt we set it to a large number for large uncertainty?
  ENDDO
	
  RETURN
END SUBROUTINE DisabLayBelowSfc


SUBROUTINE ProjCov(nR,nG,Ustar,Sa,Lambda)
  !---Input/Output variables
  INTEGER              :: nR,nG
  REAL, DIMENSION(nG,nR) :: Ustar
  REAl, DIMENSION(nG,nG) :: Sa
  REAL, DIMENSION(nR,nR) :: Lambda
  !---Local variables
  REAl, DIMENSION(nR,nG) :: UstarT
  REAL, DIMENSION(nG,nR) :: A
  UstarT = TRANSPOSE(Ustar(1:nG,1:nR))
  A      = MATMUL(Sa(1:nG,1:nG),Ustar(1:nG,1:nR))
  Lambda(1:nR,1:nR)=MATMUL(UstarT,A)
  RETURN
END SUBROUTINE ProjCov

SUBROUTINE Convgce(nchan,Ym,Y,EY,ChiSq,CvgceReached,ChiSqThresh,dY2)
  INTEGER               :: nchan,nch,ichan
  REAL,  DIMENSION(nchan) :: Ym,Y,EY,dY2
  ! INTEGER, DIMENSION(:) :: ChanSel
  REAL                  :: ChiSq,ChiSqThresh
  LOGICAL               :: CvgceReached

  ChiSq = 0.
  DO ichan=1,nchan
	 dY2(ichan) = 0.
     dY2(ichan)= (Ym(ichan)-Y(ichan))**2.
     ChiSq=ChiSq+dY2(ichan)/EY(ichan)
  ENDDO
  ChiSq=(ChiSq/nchan)
  CvgceReached=.FALSE.
  IF (ChiSq.le.ChiSqThresh) CvgceReached=.TRUE.
  RETURN
END SUBROUTINE Convgce

  FUNCTION matinv_dbl(A)
    ! Invert matrix by Gauss method
    ! --------------------------------------------------------------------
    IMPLICIT NONE
    INTEGER :: n
    REAL*8, intent(in),dimension(:,:) :: a
    REAL*8, dimension(size(a,1),size(a,2)) :: b
    REAL*8, dimension(size(a,1),size(a,2)) :: matinv_dbl
    REAL*8, dimension(size(a,1)) :: temp
    ! - - - Local Variables - - -
    REAL*8 :: c, d
    INTEGER :: i, j, k, m, imax(1), ipvt(size(a,1))
    ! - - - - - - - - - - - - - -
    b = a
    n=size(a,1)
    matinv_dbl=a
    ipvt = (/ (i, i = 1, n) /)
    ! Go into loop- b, the inverse, is initialized equal to a above
    DO k = 1,n
       ! Find the largest value and position of that value
       imax = MAXLOC(ABS(b(k:n,k)))
       m = k-1+imax(1)
       !   sigular matrix check
       if(ABS(b(m,k)).LE.(1.D-40)) then
          !CALL ErrHandl(ErrorType,Err_SingularMatrx,'')
          matinv_dbl(1,1) = -99999999.0
          return 
       ENDIF
       ! get the row beneath the current row if the current row will
       ! not compute
       IF (m .ne. k) THEN
          ipvt( (/m,k/) ) = ipvt( (/k,m/) )
          b((/m,k/),:) = b((/k,m/),:)
       END IF
       ! d is a coefficient - brings the pivot value to one and then is applied
       ! to the rest of the row
       d = 1/b(k,k)
       temp = b(:,k)
       DO j = 1, n
          c = b(k,j)*d
          b(:,j) = b(:,j)-temp*c
          b(k,j) = c
       END DO
       b(:,k) = temp*(-d)
       b(k,k) = d
    END DO
    matinv_dbl(:,ipvt) = b
  END FUNCTION matinv_dbl